<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PerformaInvoice</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-size: 12px;
      background: #e9ecef;
    }

    .no-print { display: block; }
    @media print { .no-print { display: none !important; } }

    /* ---------------------------
       INVOICE BOX WITH BORDER + 1REM SPACING
       --------------------------- */
    #invoice {
      width: 210mm;
      margin: 1rem auto !important;     /* OUTER MARGIN */
      padding: 1rem !important;         /* INNER PADDING */
      border: 2px solid #000;           /* BORDER */
      background: #ffffff;
      box-sizing: border-box;
      border-radius: 0;
    }

    .invoice-header-title {
      font-size: 26px;
      letter-spacing: 1px;
      font-weight: 600;
    }

    /* ---------------------------
       TABLE BORDER STYLING
       --------------------------- */
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      border: 2px solid #000;
      font-size: 12px;
    }

    .invoice-table th,
    .invoice-table td {
      border: 1px solid #000;
      padding: 6px;
      text-align: center;
    }

    .invoice-table th {
      background-color: #f8f9fa;
      font-weight: 700;
    }

    .table-modern {
      border: 2px solid #000 !important;
    }

    .table-modern th,
    .table-modern td {
      border: 1px solid #000 !important;
      background: #fff;
      padding: 6px;
    }

    /* Page break after 30 rows */
    .page-break { page-break-after: always; }

   @media (max-width: 768px) {
    .invoice-wrapper {
      transform: scale(0.55);
      transform-origin: top center;
      width: 100%;
      overflow-x: hidden;
    }

    #invoice {
      width: 210mm;    /* original size */
    }
  }

  </style>
</head>

<body>

<div class="invoice-wrapper">
  <div class="container-fluid" id="invoice">

    <!-- HEADER -->
    <div class="text-center" style="margin-bottom: 20px;">
      <h2 class="invoice-header-title">PERFORMA INVOICE</h2>
    </div>

    <!-- Invoice Info -->
    <div class="d-flex justify-content-between">
      <p><strong>Invoice Number:</strong> {{ order.invoice }}</p>
      <p><strong>Invoice Date:</strong> {{ order.order_date }}</p>
    </div>

    <hr style="border-top: 1px solid #000;">
    <br>

    <!-- Bill / Ship -->
    <table class="table table-modern mt-2">
      <thead>
        <tr>
          <th>Bill to</th>
          <th>Ship to</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <strong>{{ order.customer.name }}</strong><br>
            {{ order.customer.address }}<br>
            Phone: {{ order.customer.phone }}<br>
            GSTIN: {{ order.customer.gst }}
          </td>
          <td>
            {{ order.billing_address.address }}<br>
            Phone: {{ order.billing_address.phone }}
          </td>
        </tr>
      </tbody>
    </table>

    <!-- ITEMS TABLE WITH PAGE BREAK -->
    <table class="invoice-table mt-3">
      <thead>
        <tr>
          <th rowspan="2">Product</th>
          <th rowspan="2">HSN</th>
          <th rowspan="2">Rate</th>
          <th colspan="3">Taxable Amount</th>
          <th rowspan="2">Dis</th>
          <th rowspan="2">Price</th>
          <th rowspan="2">Qty</th>
          <th rowspan="2">Amount</th>
        </tr>
        <tr>
          <th>Tax %</th>
          <th>Tax Amt</th>
          <th>Net Price</th>
        </tr>
      </thead>

      <tbody>
        {% for item in items %}
        <tr>
          <td style="text-align:left;">{{ item.product.name }}</td>
          <td>{{ item.product.hsn_code }}</td>
          <td>{{ exclude_price|floatformat:2 }}</td>
          <td>{{ item.product.tax }}</td>
          <td>{{ item.tax_amount|floatformat:2 }}</td>
          <td>{{ item.final_price|floatformat:2 }}</td>
          <td>{{ item.discount|floatformat:2 }}</td>
          <td>{{ item.rate|floatformat:2 }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.total|floatformat:2 }}</td>
        </tr>

        {% if forloop.counter|divisibleby:30 %}
          </tbody>
        </table>

        <div class="page-break"></div>

        <table class="invoice-table">
          <tbody>
        {% endif %}

        {% endfor %}
      </tbody>

      <tfoot>
        <tr>
          <td colspan="8" style="text-align:right; font-weight:700;">TOTAL</td>
          <td style="font-weight:700;">{{ total_quantity }}</td>
          <td style="font-weight:700;">{{ totalamount|floatformat:2 }}</td>
        </tr>
      </tfoot>
    </table>

    <!-- BANK + SUMMARY -->
    <table class="table table-modern mt-4" style="table-layout: fixed;">
      <tr>
        <td style="width:50%;">
          <table class="table table-modern mb-0">
            <thead><tr><th colspan="2" class="text-center">Bank Details</th></tr></thead>
            <tbody>
              <tr><td>A/C Name</td><td>Michael export & import Pvt ltd</td></tr>
              <tr><td>Bank A/C</td><td>850120110000259</td></tr>
              <tr><td>Bank Name</td><td>BOI BEPO</td></tr>
              <tr><td>IFSC</td><td>BKID0008501</td></tr>
              <tr><td>Branch</td><td>MG ROAD</td></tr>
            </tbody>
          </table>
        </td>

        <td style="width:50%;">
          <table class="table table-modern mb-0">
            <tbody>
              <tr><td>Discounted Amount</td><td class="text-end">{{ discounted_amount|floatformat:2 }}</td></tr>
              <tr><td>Net Amount</td><td class="text-end">{{ totalamount|floatformat:2 }}</td></tr>
              <tr><td>Total Tax</td><td class="text-end">{{ total_tax_amount|floatformat:2 }}</td></tr>
              <tr><td>Shipping Charge</td><td class="text-end">{{ order.shipping_charge|floatformat:2 }}</td></tr>
              <tr><td><strong>Total Payable</strong></td><td class="text-end"><strong>{{ grand_total|floatformat:2 }}</strong></td></tr>
            </tbody>
          </table>
        </td>
      </tr>
    </table>

    <!-- FOOTER -->
    <div class="text-center mt-3">
      <p><strong>Thank you!</strong></p>
      <hr style="border-top: 1px dashed #000;">
      <p>This is a computer-generated invoice and does not require signature.</p>
    </div>

    <!-- DOWNLOAD -->
    <div class="button-container">
      <button class="btn btn-primary no-print" id="downloadBtn" onclick="downloadInvoice()">Download Invoice</button>
    </div>

  </div>
</div>

<script>
function downloadInvoice() {
  const btn = document.getElementById("downloadBtn");
  btn.style.display = "none";

  const wrapper = document.querySelector(".invoice-wrapper");
  const invoice = document.getElementById("invoice");

  // Save original styles
  const originalTransform = wrapper.style.transform;
  const originalWidth = invoice.style.width;

  /* FIX FOR MOBILE SCREEN CAPTURE */
  wrapper.style.transform = "none";                 // remove scaling
  wrapper.style.webkitTransform = "none";           // iPhone fix
  wrapper.style.msTransform = "none";
  
  invoice.style.width = "210mm";                    // force real A4 width
  invoice.style.maxWidth = "210mm";

  /* SCROLL FIX FOR IOS / ANDROID */
  window.scrollTo(0, 0);

  html2canvas(invoice, {
      scale: 3,                 // higher dpi â†’ sharper, no overlap
      useCORS: true,
      allowTaint: true
  }).then(canvas => {

      const pdf = new jspdf.jsPDF("p", "mm", "a4");
      const imgData = canvas.toDataURL("image/png");

      pdf.addImage(imgData, "PNG", 0, 0, 210, 297);
      pdf.save("PerformaInvoice.pdf");

      // Restore original state
      wrapper.style.transform = originalTransform;
      invoice.style.width = originalWidth;
      btn.style.display = "block";
  });
}

</script>

</body>
</html>
