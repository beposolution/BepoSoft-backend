<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PerformaInvoice</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      font-size: 12px;
      background: #e9ecef;
    }

    .no-print { display: block; }
    @media print { .no-print { display: none !important; } }

    .button-container {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
      padding-bottom: 20px;
    }

    .container {
      max-width: 100%;
      padding-left: 12px;
      padding-right: 12px;
    }

    /* ---------------------------
       OUTLINE: FULL INVOICE BOX
       --------------------------- */
    #invoice {
      width: 210mm;
      margin: 20px auto;
      padding: 18px 22px;
      border: 2px solid #000;      /* OUTLINE */
      background: #ffffff;
      box-sizing: border-box;
      box-shadow: none;
      border-radius: 0;
    }

    .invoice-header-title {
      font-size: 26px;
      letter-spacing: 1px;
      font-weight: 600;
    }

    /* ---------------------------
       OUTLINE: TABLE STYLING
       --------------------------- */
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      page-break-inside: auto;
      font-size: 12px;
      border: 2px solid #000;    /* Outer table border */
    }

    .invoice-table th,
    .invoice-table td {
      border: 1px solid #000;    /* Inner borders */
      padding: 6px;
      text-align: center;
    }

    .invoice-table th {
      background-color: #f8f9fa;
      font-weight: 600;
    }

    .table-modern {
      border: 2px solid #000 !important; /* Bill/Ship & Bank/Summary outline */
    }

    .table-modern th,
    .table-modern td {
      border: 1px solid #000 !important; /* Inner borders */
      padding: 6px;
      background: #ffffff;
      vertical-align: top;
    }

    .table-modern thead th {
      background-color: #f8f9fa;
      font-weight: 600;
    }

    /* Mobile scaling */
    .invoice-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      overflow-x: hidden;
    }

    @media print {
      html, body {
        margin: 0;
        padding: 0;
        width: 210mm;
        background: #fff;
      }
      .container, .container-fluid {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      #invoice {
        margin: 0;
        border-radius: 0;
        box-shadow: none;
      }
    }

    @media (max-width: 768px) {
      html, body {
        width: 100%;
        background: #fff;
        overflow-x: auto !important;
      }
      .invoice-wrapper {
        transform: scale(0.55);
        transform-origin: top center;
      }
      #invoice {
        width: 210mm;
        padding: 18px 22px;
      }
      table { font-size: 10px; }
    }
  </style>
</head>

<body>
  <div class="invoice-wrapper">
    <div class="container-fluid" id="invoice">

      <!-- Heading -->
      <div class="text-center" style="margin-top: 25px; margin-bottom: 20px;">
        <h2 class="invoice-header-title">PERFORMA INVOICE</h2>
      </div>

      <!-- Invoice Info Row -->
      <div class="d-flex justify-content-between" style="font-size: 12px;">
        <p><strong>Invoice Number:</strong> {{ order.invoice }}</p>
        <p><strong>Invoice Date:</strong> {{ order.order_date }}</p>
      </div>

      <hr style="border-top: 1px solid #000;">
      <br>

      <!-- BILL TO / SHIP TO -->
      <table class="table table-modern mt-2">
        <thead>
          <tr>
            <th>Bill to</th>
            <th>Ship to</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <strong>{{ order.customer.name }}</strong><br>
              {{ order.customer.address }}<br>
              Phone: {{ order.customer.phone }}<br>
              GSTIN: {{ order.customer.gst }}
            </td>
            <td>
              {{ order.billing_address.address }}<br>
              Phone: {{ order.billing_address.phone }}
            </td>
          </tr>
        </tbody>
      </table>

      <!-- ITEMS TABLE -->
      <table class="invoice-table mt-3">
        <thead>
          <tr>
            <th rowspan="2">Product</th>
            <th rowspan="2">HSN Code</th>
            <th rowspan="2">Rate</th>
            <th colspan="3">Taxable Amount</th>
            <th rowspan="2">Dis</th>
            <th rowspan="2">Price</th>
            <th rowspan="2">Qty</th>
            <th rowspan="2">Amount</th>
          </tr>
          <tr>
            <th>Tax in(%)</th>
            <th>Tax Amount</th>
            <th>Net Price</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td style="text-align:left;">{{ item.product.name }}</td>
            <td>{{ item.product.hsn_code }}</td>
            <td>{{ exclude_price|floatformat:2 }}</td>
            <td>{{ item.product.tax }}</td>
            <td>{{ item.tax_amount|floatformat:2 }}</td>
            <td>{{ item.final_price|floatformat:2 }}</td>
            <td>{{ item.discount|floatformat:2 }}</td>
            <td>{{ item.rate|floatformat:2 }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ item.total|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>

        <tfoot>
          <tr>
            <td colspan="8" style="text-align: right; font-weight: 700;">TOTAL</td>
            <td style="font-weight: 700;">{{ total_quantity }}</td>
            <td style="font-weight: 700;">{{ totalamount|floatformat:2 }}</td>
          </tr>
        </tfoot>
      </table>

      <!-- BANK + SUMMARY -->
      <table class="table table-modern mt-4" style="table-layout: fixed;">
        <tr>
          <!-- BANK DETAILS -->
          <td style="width: 50%; vertical-align: top;">
            <table class="table table-modern mb-0">
              <thead>
                <tr><th colspan="2" class="text-center">Bank Details</th></tr>
              </thead>
              <tbody>
                <tr><td><strong>A/C Name</strong></td><td>Michael export & import Pvt ltd</td></tr>
                <tr><td><strong>Bank A/C</strong></td><td>850120110000259</td></tr>
                <tr><td><strong>Bank Name</strong></td><td>BOI BEPO</td></tr>
                <tr><td><strong>IFSC</strong></td><td>BKID0008501</td></tr>
                <tr><td><strong>Branch</strong></td><td>MG ROAD</td></tr>
              </tbody>
            </table>
          </td>

          <!-- SUMMARY -->
          <td style="width: 50%; vertical-align: top;">
            <table class="table table-modern mb-0">
              <tbody>
                <tr><td><strong>Discounted Amount</strong></td><td class="text-end">{{ discounted_amount|floatformat:2 }}</td></tr>
                <tr><td><strong>Net Amount</strong></td><td class="text-end">{{ totalamount|floatformat:2 }}</td></tr>
                <tr><td><strong>Total Tax</strong></td><td class="text-end">{{ total_tax_amount|floatformat:2 }}</td></tr>
                <tr><td><strong>Shipping Charge</strong></td><td class="text-end">{{ order.shipping_charge|floatformat:2 }}</td></tr>
                <tr><td><strong>Total Payable</strong></td><td class="text-end"><strong>{{ grand_total|floatformat:2 }}</strong></td></tr>
              </tbody>
            </table>
          </td>
        </tr>
      </table>

      <!-- FOOTER -->
      <div class="text-center mt-3">
        <p><strong>Thank you!</strong></p>
        <hr style="border-top: 1px dashed #000;">
        <p>Invoice is computer-generated and does not require signature.</p>
      </div>

      <!-- DOWNLOAD BUTTON -->
      <div class="button-container">
        <button class="btn btn-primary no-print" id="downloadBtn" onclick="downloadInvoice()">Download Invoice</button>
      </div>

    </div>
  </div>

  <script>
    function downloadInvoice() {
      const btn = document.getElementById("downloadBtn");
      btn.style.display = "none";

      const wrapper = document.querySelector(".invoice-wrapper");
      const invoice = document.getElementById("invoice");

      const originalTransform = wrapper.style.transform;
      wrapper.style.transform = "none";

      const a4Width = 1240;
      const originalWidth = invoice.style.width;
      invoice.style.width = a4Width + "px";

      html2canvas(invoice, { scale: 2 }).then(canvas => {
        const pdf = new jspdf.jsPDF("p","mm","a4");
        pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, 210, 297);
        pdf.save("PerformaInvoice.pdf");

        invoice.style.width = originalWidth;
        wrapper.style.transform = originalTransform;
        btn.style.display = "block";
      });
    }
  </script>

</body>
</html>
